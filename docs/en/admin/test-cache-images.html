<!DOCTYPE html>
<html>
<head>
    <title>Test Cache Immagini</title>
    <link rel="stylesheet" href="editor.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
</head>
<body style="padding: 20px; font-family: Arial, sans-serif;">
    <h1>ğŸ–¼ï¸ Test Sistema Cache Immagini</h1>
    
    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3>ğŸ”§ Configurazione Test</h3>
        <input type="text" id="username" placeholder="GitHub Username" value="Leonardo-Cyber-Security" style="margin: 5px; padding: 8px; width: 200px;">
        <input type="text" id="repo" placeholder="Repository Name" value="multilanguage_scmp" style="margin: 5px; padding: 8px; width: 200px;">
        <input type="password" id="token" placeholder="GitHub Token" style="margin: 5px; padding: 8px; width: 200px;">
        <br>
        <button id="testCacheBtn" style="margin: 10px 5px; padding: 10px 20px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸš€ Test Cache Immagini</button>
    </div>
    
    <div id="cache-status" style="background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin: 20px 0;">
        <h3>ğŸ“Š Status Cache</h3>
        <div id="cache-info">Premi il bottone per iniziare il test...</div>
    </div>
    
    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>ğŸ–¼ï¸ Immagini in Cache</h3>
            <div id="images-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: white;"></div>
        </div>
        
        <div style="flex: 1;">
            <h3>ğŸ“‹ Log Operazioni</h3>
            <div id="log-output" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f4f4f4; font-family: monospace; font-size: 11px;"></div>
        </div>
    </div>
    
    <!-- Indicatore di caricamento immagini -->
    <div id="images-loading-indicator" style="display: none; position: fixed; top: 10px; right: 10px; background: #007acc; color: white; padding: 8px 15px; border-radius: 20px; z-index: 1000; font-size: 12px;">
        ğŸ–¼ï¸ Caricamento immagini: <span id="images-progress">0/0</span>
    </div>
    
    <!-- Simula le variabili globali come nell'app -->
    <script>
        window.currentUsername = null;
        window.currentRepo = null;
        window.currentToken = null;
        window.cachedImages = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            $("#log-output").append(`[${timestamp}] ${message}\n`);
            $("#log-output").scrollTop($("#log-output")[0].scrollHeight);
            console.log(message);
        }
        
        function updateCacheStatus() {
            const total = window.cachedImages.length;
            const loaded = window.cachedImages.filter(img => img.dataUrl).length;
            const sizeTotal = window.cachedImages.reduce((sum, img) => sum + (img.size || 0), 0);
            
            $("#cache-info").html(`
                <div>ğŸ“¦ <strong>Immagini totali:</strong> ${total}</div>
                <div>âœ… <strong>Caricate in cache:</strong> ${loaded}</div>
                <div>ğŸ“ <strong>Dimensione totale:</strong> ${(sizeTotal / 1024).toFixed(1)} KB</div>
                <div>âš¡ <strong>Stato:</strong> ${loaded === total ? 'ğŸ‰ Cache completa!' : 'â³ Caricamento in corso...'}</div>
            `);
        }
        
        function displayImages() {
            let html = '';
            window.cachedImages.forEach(img => {
                const status = img.dataUrl ? 'âœ…' : 'â³';
                const preview = img.dataUrl ? `<img src="${img.dataUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-left: 10px;">` : '';
                html += `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                        <span>${status}</span>
                        <span style="margin-left: 10px; flex: 1;">${img.name}</span>
                        <span style="margin-left: 10px; color: #666; font-size: 11px;">${img.size ? (img.size / 1024).toFixed(1) + ' KB' : ''}</span>
                        ${preview}
                    </div>
                `;
            });
            $("#images-list").html(html);
        }
        
        // Simula la funzione loadImagesList dell'app
        function loadImagesList(callback) {
            log("ğŸ–¼ï¸ Caricamento lista immagini e cache...");
            updateCacheStatus();
            
            // Mostra indicatore di caricamento
            $("#images-loading-indicator").show();
            
            $.ajax({
                url: `https://api.github.com/repos/${window.currentUsername}/${window.currentRepo}/contents/overrides/assets/images/extract/media`,
                headers: { Authorization: `token ${window.currentToken}` },
                success: files => {
                    const imageFiles = files.filter(f => f.type === "file" && /\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(f.name));
                    
                    window.cachedImages = imageFiles.map(f => ({
                        name: f.name, 
                        local: "images/extract/media/" + f.name, 
                        download_url: f.download_url, 
                        dataUrl: null,
                        sha: f.sha,
                        size: f.size
                    }));
                    
                    log(`ğŸ“¦ Trovate ${window.cachedImages.length} immagini da scaricare...`);
                    $("#images-progress").text(`0/${window.cachedImages.length}`);
                    displayImages();
                    updateCacheStatus();
                    
                    if (window.cachedImages.length === 0) {
                        log("ğŸ“­ Nessuna immagine trovata");
                        $("#images-loading-indicator").hide();
                        if (callback) callback(window.cachedImages);
                        return;
                    }
                    
                    let pending = window.cachedImages.length;
                    let downloaded = 0;
                    
                    // Scarica tutte le immagini in parallelo per performance
                    window.cachedImages.forEach((img, idx) => {
                        $.ajax({
                            url: img.download_url, 
                            xhrFields: { responseType: "blob" },
                            success: blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    window.cachedImages[idx].dataUrl = reader.result;
                                    downloaded++;
                                    $("#images-progress").text(`${downloaded}/${window.cachedImages.length}`);
                                    log(`âœ… Immagine ${downloaded}/${window.cachedImages.length} scaricata: ${img.name}`);
                                    displayImages();
                                    updateCacheStatus();
                                    
                                    if (--pending === 0) {
                                        log("ğŸ‰ Tutte le immagini caricate in cache!");
                                        $("#images-loading-indicator").hide();
                                        if (callback) callback(window.cachedImages);
                                    }
                                };
                                reader.readAsDataURL(blob);
                            },
                            error: (xhr) => {
                                log(`âŒ Errore scaricamento ${img.name}: ${xhr.status}`);
                                if (--pending === 0) {
                                    log(`âš ï¸ Cache immagini completata con ${downloaded} successi su ${window.cachedImages.length}`);
                                    $("#images-loading-indicator").hide();
                                    updateCacheStatus();
                                    if (callback) callback(window.cachedImages);
                                }
                            }
                        });
                    });
                },
                error: (xhr) => { 
                    log(`âŒ Errore caricamento lista immagini: ${xhr.status}`);
                    $("#images-loading-indicator").hide();
                    window.cachedImages = []; 
                    updateCacheStatus();
                    if (callback) callback([]);
                }
            });
        }
        
        $(document).ready(function() {
            $("#testCacheBtn").on("click", function() {
                window.currentUsername = $("#username").val();
                window.currentRepo = $("#repo").val();
                window.currentToken = $("#token").val();
                
                if (!window.currentUsername || !window.currentRepo || !window.currentToken) {
                    alert("âš ï¸ Compila tutti i campi!");
                    return;
                }
                
                log("ğŸš€ Avvio test cache immagini...");
                $("#log-output").empty();
                
                loadImagesList(function(images) {
                    log(`ğŸ“Š Test completato: ${images.length} immagini processate`);
                    const loaded = images.filter(img => img.dataUrl).length;
                    log(`ğŸ“ˆ Risultato: ${loaded}/${images.length} immagini caricate con successo`);
                });
            });
        });
    </script>
</body>
</html>