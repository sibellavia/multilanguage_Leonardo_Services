name: Automatic doc update (EN + IT)

on:
  push:
    branches:
    - main

permissions:
  contents: write

env:
  RUN_CHECKOUT: 'true'
  RUN_SETUP: 'true'
  RUN_FETCH_HISTORY: 'true'
  RUN_SWAGGER: 'true'
  RUN_VERSIONING: 'true'
  RUN_BUILD_DOCS: 'true'
  RUN_GENERATE_PDF: 'true'
  RUN_DEPLOY_DOCS: 'true' # Mike deployment attivato

jobs:
  doc_pipeline:
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout repository
      if: env.RUN_CHECKOUT == 'true'
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python
      if: env.RUN_SETUP == 'true'
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install dependencies
      if: env.RUN_SETUP == 'true'
      run: pip install -r preConfiguration/requirements.txt beautifulsoup4 pyyaml

    - name: Set Git user
      if: env.RUN_SETUP == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Fetch all history
      if: env.RUN_FETCH_HISTORY == 'true'
      run: git fetch --all

    - name: Fetch gh-pages branch
      if: env.RUN_FETCH_HISTORY == 'true'
      run: |
        git fetch origin gh-pages
        git checkout origin/gh-pages -- latest

    - name: Check if 'latest' is a symlink or a directory
      if: env.RUN_FETCH_HISTORY == 'true'
      run: ls -l latest

    - name: Determine next version
      if: env.RUN_VERSIONING == 'true'
      id: versioning
      run: |
        # Gestisci il caso quando 'latest' non esiste o non √® un symlink
        if [ -L latest ]; then
          latest_version=$(readlink latest)
          echo "Latest version from symlink: $latest_version"
        elif [ -f latest ]; then
          latest_version=$(cat latest)
          echo "Latest version from file: $latest_version"
        else
          latest_version="7.10.0"
          echo "No latest found, starting from: $latest_version"
        fi

        anno=7
        last_mese=$(echo "$latest_version" | awk -F. '{print $2}')
        last_patch=$(echo "$latest_version" | awk -F. '{print $3}')

        mese=$(date +'%m')

        if [ "$mese" != "$last_mese" ]; then
          nuova_patch=0
        else
          nuova_patch=$((last_patch + 1))
        fi

        nuova_versione="${anno}.${mese}.${nuova_patch}"
        echo "Calcolata nuova versione: $nuova_versione"

        echo "new_version=$nuova_versione" >> $GITHUB_ENV
        echo "new_version=$nuova_versione" >> $GITHUB_OUTPUT

    - name: Generate mkdocs configs (EN + IT)
      run: python preConfiguration/build/build_config.py
    - name: Prepare PDF template
      run: |
        mkdir -p documentation/pdfGeneration
        python preConfiguration/pdf/pdf_config.py

    # ----------------------------
    # üü¢ BUILD + PDF ITALIANO
    # ----------------------------
    - name: Build documentation IT
      if: env.RUN_BUILD_DOCS == 'true'
      run: mkdocs build -f config/it/mkdocs.yml

    - name: Renumber figcaptions IT
      if: env.RUN_BUILD_DOCS == 'true'
      run: |
        if [ -f generated/it/print_page/index.html ]; then \
          python preConfiguration/build/figureEnumerator.py generated/it/print_page/index.html; \
        else \
          echo "print_page.html (IT) non trovato"; \
        fi

    - name: Install wkhtmltopdf
      run: |
        wget https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.focal_amd64.deb
        sudo apt install -y ./wkhtmltox_0.12.5-1.focal_amd64.deb

    - name: Generate PDF IT
      if: env.RUN_GENERATE_PDF == 'true'
      run: |
        mkdir -p generated/pdf
        if [ -f generated/it/print_page/index.html ]; then \
        wkhtmltopdf \
          --enable-local-file-access \
          --enable-javascript \
          --javascript-delay 1000 \
          --print-media-type \
          --disable-smart-shrinking \
          --dpi 200 \
          --encoding UTF-8 \
          --header-html "file://$(pwd)/documentation/pdfGeneration/pdf-header.html" \
          --footer-html "file://$(pwd)/documentation/pdfGeneration/pdf-footer.html" \
          --user-style-sheet "file://$(pwd)/documentation/pdfGeneration/pdf-leonardo.css" \
          --footer-spacing 10 \
          --header-spacing 10 \
          --margin-top 51.317 \
          --margin-bottom 33.56 \
          --margin-left 19.138 \
          --margin-right 13 \
          "file://$(pwd)/documentation/pdfGeneration/pdf-firstPage.html" \
          "file://$(pwd)/generated/it/print_page/index.html" \
          "$(pwd)/generated/pdf/SCMP_SUM_it.pdf"; \
        else echo "print_page.html IT non generato"; fi

    # ----------------------------
    # üü¢ BUILD + PDF ENGLISH
    # ----------------------------
    - name: Build documentation EN
      if: env.RUN_BUILD_DOCS == 'true'
      run: mkdocs build -f config/en/mkdocs.yml

    - name: Renumber figcaptions EN
      if: env.RUN_BUILD_DOCS == 'true'
      run: |
        if [ -f generated/en/print_page/index.html ]; then \
          python preConfiguration/build/figureEnumerator.py generated/en/print_page/index.html; \
        else \
          echo "print_page.html (EN) non trovato"; \
        fi

    - name: Generate PDF EN
      if: env.RUN_GENERATE_PDF == 'true'
      run: |
        mkdir -p generated/pdf
        if [ -f generated/en/print_page/index.html ]; then \
        wkhtmltopdf \
          --enable-local-file-access \
          --enable-javascript \
          --javascript-delay 1000 \
          --print-media-type \
          --disable-smart-shrinking \
          --dpi 200 \
          --encoding UTF-8 \
          --header-html "file://$(pwd)/documentation/pdfGeneration/pdf-header.html" \
          --footer-html "file://$(pwd)/documentation/pdfGeneration/pdf-footer.html" \
          --user-style-sheet "file://$(pwd)/documentation/pdfGeneration/pdf-leonardo.css" \
          --footer-spacing 10 \
          --header-spacing 10 \
          --margin-top 51.317 \
          --margin-bottom 33.56 \
          --margin-left 19.138 \
          --margin-right 13 \
          "file://$(pwd)/documentation/pdfGeneration/pdf-firstPage.html" \
          "file://$(pwd)/generated/en/print_page/index.html" \
          "$(pwd)/generated/pdf/SCMP_SUM_en.pdf"; \
        else echo "print_page.html EN non generato"; fi

    - name: Update nav configs for HTML links and rebuild
      if: env.RUN_SWAGGER == 'true'
      run: |
        echo "üîÑ Updating nav configs to use /index.html instead of .md"

        # Backup original nav configs
        cp preConfiguration/build/nav_config_it.yml preConfiguration/build/nav_config_it.yml.backup
        cp preConfiguration/build/nav_config_en.yml preConfiguration/build/nav_config_en.yml.backup

        # Replace .md with /index.html in nav configs
        sed -i 's/\.md$/\/index.html/g' preConfiguration/build/nav_config_it.yml
        sed -i 's/\.md$/\/index.html/g' preConfiguration/build/nav_config_en.yml

        echo "‚úÖ Nav configs updated for HTML links"
        echo "üìÑ IT nav config:"
        cat preConfiguration/build/nav_config_it.yml
        echo "üìÑ EN nav config:"
        cat preConfiguration/build/nav_config_en.yml

        # Regenerate mkdocs configs with HTML links
        python preConfiguration/build/build_config.py

        # Rebuild documentation with HTML links
        echo "üîÑ Rebuilding documentation with HTML links..."
        mkdocs build -f config/it/mkdocs.yml
        mkdocs build -f config/en/mkdocs.yml

        # Restore original nav configs
        mv preConfiguration/build/nav_config_it.yml.backup preConfiguration/build/nav_config_it.yml
        mv preConfiguration/build/nav_config_en.yml.backup preConfiguration/build/nav_config_en.yml

        # Copy PDF files to respective language directories
        echo "üîÑ Copying PDF files to language directories..."
        if [ -f generated/pdf/SCMP_SUM_it.pdf ]; then
          cp generated/pdf/SCMP_SUM_it.pdf generated/it/
          echo "‚úÖ Copied SCMP_SUM_it.pdf to generated/it/"
        fi
        if [ -f generated/pdf/SCMP_SUM_en.pdf ]; then
          cp generated/pdf/SCMP_SUM_en.pdf generated/en/
          echo "‚úÖ Copied SCMP_SUM_en.pdf to generated/en/"
        fi

        echo "‚úÖ Documentation rebuilt with HTML links, nav configs restored"

    - name: Copy index.html to index/index.html
      run: |
        echo "üîÑ Copying index.html files to index/index.html..."

        # Copy IT index.html
        if [ -f generated/it/index.html ]; then
          mkdir -p generated/it/index
          cp generated/it/index.html generated/it/index/index.html
          
          # Remove all index/ references from the copied file
          sed -i 's|index/||g' generated/it/index/index.html
          
          echo "‚úÖ Copied generated/it/index.html to generated/it/index/index.html and fixed paths"
        else
          echo "‚ö†Ô∏è generated/it/index.html not found"
        fi

        # Copy EN index.html
        if [ -f generated/en/index.html ]; then
          mkdir -p generated/en/index
          cp generated/en/index.html generated/en/index/index.html
          
          # Remove all index/ references from the copied file
          sed -i 's|index/||g' generated/en/index/index.html
          
          echo "‚úÖ Copied generated/en/index.html to generated/en/index/index.html and fixed paths"
        else
          echo "‚ö†Ô∏è generated/en/index.html not found"
        fi

        echo "‚úÖ Index files copy completed with path fixes"

    - name: Resize and optimize images
      run: |
        echo "üîÑ Resizing and optimizing images..."
        python preConfiguration/build/image_resizier.py
        echo "‚úÖ Image optimization completed"

    # ----------------------------
    # üîπ DEPLOY PREBUILT SU GH-PAGES (Senza Mike)
    # ----------------------------
    - name: Deploy prebuilt to gh-pages
      if: env.RUN_DEPLOY_DOCS == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e

        echo "Deploying version ${new_version}"

        # Configura Git
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        # Clona il branch gh-pages in una cartella temporanea
        TMP_DIR=$(mktemp -d)
        git clone --branch gh-pages --single-branch https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git $TMP_DIR

        cd $TMP_DIR

        # Crea la cartella versione numerica
        VERSION_DIR="${new_version}"
        mkdir -p "$VERSION_DIR"

        # Copia tutto da generated/ nella cartella versione
        cp -a $GITHUB_WORKSPACE/generated/. "$VERSION_DIR/"

        # Crea/aggiorna il symlink latest
        rm -f latest
        ln -s "$new_version" latest

        # Commit & push
        git add .
        git commit -m "Deploy documentation version ${new_version} [ci skip]" || echo "No changes to commit"
        git push origin gh-pages

        echo "‚úÖ Deploy su gh-pages completato!"
